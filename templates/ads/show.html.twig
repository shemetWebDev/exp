{% extends 'base.html.twig' %}

{% block title %}
	{{ ad.title }}
	‚Äî –û–±—ä—è–≤–ª–µ–Ω–∏–µ ‚Ññ{{ ad.id }}
	| ExpFR
{% endblock %}

{# üîπ –ú–ï–¢–ê-–¢–ï–ì–ò (OpenGraph + Twitter) –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ Telegram / WhatsApp / Facebook #}
{% block meta %}
	{% set mainImage = '' %}
	{% if ad.photos is iterable and ad.photos|length > 0 %}
		{% set mainImage = asset('uploads/ads/' ~ ad.photos[0]) %}
	{% elseif ad.photo is defined and ad.photo %}
		{% set mainImage = asset('uploads/ads/' ~ ad.photo) %}
	{% else %}
		{% set mainImage = asset('images/no-photo.jpg') %}
	{% endif %}

	<meta property="og:title" content="{{ ad.title|e }}"/>
	<meta property="og:description" content="{{ ad.description|striptags|trim|slice(0, 180) }}"/>
	<meta property="og:type" content="article"/>
	<meta property="og:url" content="{{ absolute_url(path('app_ads_show', {'id': ad.id})) }}"/>
	<meta property="og:image" content="{{ absolute_url(mainImage) }}"/>
	<meta property="og:site_name" content="ExpFR.fr"/>
	<meta property="og:locale" content="fr_FR"/>

	<meta name="twitter:card" content="summary_large_image"/>
	<meta name="twitter:title" content="{{ ad.title|e }}"/>
	<meta name="twitter:description" content="{{ ad.description|striptags|trim|slice(0, 180) }}"/>
	<meta name="twitter:image" content="{{ absolute_url(mainImage) }}"/>
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset('css/ad.css') }}">
{% endblock %}

{% block body %}
	{% set images = [] %}
	{% if ad.photos is iterable and ad.photos|length > 0 %}
		{% set images = ad.photos %}
	{% elseif ad.photo is defined and ad.photo %}
		{% set images = [ad.photo] %}
	{% endif %}

	<div class="ad-page">
		<header class="ad-hero">
			<h1 class="ad-hero__title">{{ ad.title }}</h1>

			<div class="ad-hero__price">
				{% if ad.price is not null %}
					{{ ad.price }}
					‚Ç¨
				{% else %}
					‚Äî
				{% endif %}
			</div>

			<div class="ad-hero__meta">
				<span>{{ ad.city }}
					{% if ad.posteCode %}
						({{ ad.posteCode }})
					{% endif %}
				</span>
				<span class="ad-hero__dot">‚Ä¢</span>
				<time datetime="{{ ad.createdAt ? ad.createdAt|date('c') : '' }}">
					–°–æ–∑–¥–∞–Ω–æ:
					{{ ad.createdAt ? ad.createdAt|date('d.m.Y H:i') : '' }}
				</time>
				<span class="ad-hero__dot">‚Ä¢</span>
				{% include 'ads/_like.html.twig' with { ad: ad } %}
			</div>

			{% set lead = ad.description ? ad.description|striptags|trim|slice(0, 140) ~ (ad.description|length > 140 ? '‚Ä¶' : '') : '' %}
			{% if lead %}
				<p class="ad-hero__lead">{{ lead }}</p>
			{% endif %}
		</header>

		<div class="ad-main">
			<div class="ad-left">
				<section class="ad-gallery" data-gallery>
					{% if images|length > 0 %}
						<div class="ad-gallery__stage" aria-live="polite">
							{% for src in images %}
								<div class="ad-gallery__slide{% if loop.first %} is-active{% endif %}" data-index="{{ loop.index0 }}">
									<img class="ad-gallery__img" src="{{ asset('uploads/ads/' ~ src) }}" alt="{{ ad.title ~ ' ‚Äî —Ñ–æ—Ç–æ ' ~ loop.index ~ ' –∏–∑ ' ~ images|length }}" loading="lazy" draggable="false"/>
								</div>
							{% endfor %}
							{% if images|length > 1 %}
								<button type="button" class="ad-gallery__nav ad-gallery__nav--prev" data-prev aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ">‚Äπ</button>
								<button type="button" class="ad-gallery__nav ad-gallery__nav--next" data-next aria-label="–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ">‚Ä∫</button>
							{% endif %}
						</div>

						{% if images|length > 1 %}
							<div class="ad-gallery__thumbs" role="tablist">
								{% for src in images %}
									<button type="button" class="ad-gallery__thumb{% if loop.first %} is-active{% endif %}" data-go="{{ loop.index0 }}" role="tab" aria-selected="{{ loop.first ? 'true' : 'false' }}">
										<img src="{{ asset('uploads/ads/' ~ src) }}" alt="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ {{ loop.index }}">
									</button>
								{% endfor %}
							</div>
						{% endif %}
					{% else %}
						<div class="ad-gallery__placeholder">
							<svg class="ad-gallery__ph-icon" viewbox="0 0 24 24" aria-hidden="true">
								<path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14m18 0H3m18 0v1a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-1m14-8-3 3-2-2-4 4" fill="none" stroke="currentColor" stroke-width="1.5"/>
							</svg>
						</div>
					{% endif %}
				</section>

				{% if ad.description %}
					<section class="ad-details">
						<h2 class="ad-details__title">–û–ø–∏—Å–∞–Ω–∏–µ</h2>
						<p class="ad-details__text">{{ ad.description }}</p>
					</section>
				{% endif %}
			</div>

			<aside class="ad-summary">
				<div class="ad-summary__card">
					<div class="ad-summary__price">
						{% if ad.price is not null %}
							{{ ad.price }}
							‚Ç¨
						{% else %}
							‚Äî
						{% endif %}
					</div>

					<div class="ad-summary__meta">
						{{ ad.city }}
						{% if ad.posteCode %}
							({{ ad.posteCode }})
						{% endif %}
					</div>

					<div class="ad-summary__actions">
						<a href="{{ path('app_ads_index') }}" class="btn btn--soft">‚Üê –ù–∞–∑–∞–¥</a>

						{% if app.user and (is_granted('ROLE_ADMIN')
						    or (ad.user is defined and ad.user == app.user)
						    or (ad.owner is defined and ad.owner == app.user)
						    or (ad.author is defined and ad.author == app.user)) %}
							<form method="post" action="{{ path('app_ads_delete', {'id': ad.id}) }}" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?');" class="ad-delete-form">
								<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ ad.id) }}">
								<button type="submit" class="btn btn--danger-soft">–£–¥–∞–ª–∏—Ç—å</button>
							</form>
						{% endif %}
					</div>
				</div>
			</aside>
		</div>
	</div>

	{# –õ–∞–π—Ç–±–æ–∫—Å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π #}
	<div class="ad-lightbox" data-lightbox hidden>
		<button type="button" class="ad-lightbox__close" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
		<img class="ad-lightbox__img" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
		<button type="button" class="ad-lightbox__arrow ad-lightbox__arrow--prev" data-lb-prev aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ">‚Äπ</button>
		<button type="button" class="ad-lightbox__arrow ad-lightbox__arrow--next" data-lb-next aria-label="–°–ª–µ–¥—É—é—â–µ–µ">‚Ä∫</button>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="{{ asset('js/ad.js') }}"></script>
	<script src="{{ asset('js/like.js') }}"></script>
{% endblock %}
